<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Spider Forward then Fade Out (fixed)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- ç…§æ˜Ž -->
      <a-light type="ambient" color="#777"></a-light>
      <a-light type="directional" color="#fff" position="1 2 2"></a-light>

      <!-- èƒŒæ™¯ -->
      <a-sky src="mori.jpg" rotation="0 -130 0"></a-sky>

      <!-- ðŸ•·ï¸ ã‚¯ãƒ¢ -->
      <a-entity
        id="spider"
        gltf-model="spider.glb"
        animation-mixer
        position="0 -1.5 -3"
        scale="0.2 0.2 0.2"
        animation__move="property: position; to: 0 -1.5 5; dur: 8000; easing: linear; loop: false;">
      </a-entity>

      <!-- åŠ¹æžœéŸ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ -->
      <a-entity id="sound-player"></a-entity>
    </a-scene>

    <script>
      // ðŸ•·ï¸ ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å¾Œã«å…¨ãƒ¡ãƒƒã‚·ãƒ¥ã‚’é€æ˜Žå¯¾å¿œã«ã™ã‚‹
      const spider = document.querySelector('#spider');
      spider.addEventListener('model-loaded', () => {
        spider.object3D.traverse(node => {
          if (node.isMesh) {
            node.material.transparent = true; // ãƒ•ã‚§ãƒ¼ãƒ‰å¯èƒ½ã«ã™ã‚‹
          }
        });
      });

      // ðŸ•·ï¸ å‰é€²å®Œäº†å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
      spider.addEventListener('animationcomplete__move', () => {
        let opacity = 1.0;
        const fadeDuration = 2000; // 2ç§’ã§æ¶ˆãˆã‚‹
        const fadeSteps = 20;
        const stepTime = fadeDuration / fadeSteps;

        const fadeInterval = setInterval(() => {
          opacity -= 1 / fadeSteps;
          if (opacity <= 0) {
            opacity = 0;
            clearInterval(fadeInterval);
            spider.parentNode.removeChild(spider); // DOMã‹ã‚‰å‰Šé™¤ã—ã¦å®Œå…¨ã«æ¶ˆã™
          }

          spider.object3D.traverse(node => {
            if (node.isMesh && node.material) {
              node.material.opacity = opacity;
            }
          });
        }, stepTime);
      });

      // ðŸŽµ åŠ¹æžœéŸ³å‡¦ç†ï¼ˆå…ƒã®ã¾ã¾ï¼‰
      const soundFiles = [
        "åŠ¹æžœéŸ³/hell_gear.mp3",
        "åŠ¹æžœéŸ³/çªé¢¨ãŒå¹ã.mp3",
        "åŠ¹æžœéŸ³/é¢¨ãŒå¹ã1.mp3",
        "åŠ¹æžœéŸ³/é¢¨ãŒå¹ã2.mp3",
        "åŠ¹æžœéŸ³/é¢¨ãŒå¹ã3.mp3",
        "åŠ¹æžœéŸ³/é¢¨ãŒå¹ã4.mp3"
      ];

      const soundEntity = document.querySelector('#sound-player');

      function playRandomSound() {
        const randomSound = soundFiles[Math.floor(Math.random() * soundFiles.length)];
        soundEntity.setAttribute('sound', `src: url(${randomSound}); autoplay: true; volume: 1.0; loop: false;`);
        soundEntity.addEventListener('sound-loaded', () => {
          soundEntity.components.sound.playSound();
        }, { once: true });
      }

      function startRandomLoop() {
        playRandomSound();
        setInterval(() => {
          playRandomSound();
        }, Math.random() * 7000 + 8000);
      }

      window.addEventListener('load', startRandomLoop);
    </script>
  </body>
</html>
