<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Kaijyu Random Multi Scare (Fixed)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- ç…§æ˜ -->
      <a-light type="ambient" color="#222"></a-light>
      <a-light type="directional" color="#888" position="2 4 3"></a-light>

      <!-- èƒŒæ™¯ -->
      <a-sky src="mori.jpg" rotation="0 -130 0"></a-sky>

      <!-- åŠ¹æœéŸ³å†ç”Ÿç”¨ -->
      <a-entity id="sound-player"></a-entity>

      <!-- ã‚«ãƒ¡ãƒ© -->
      <a-entity id="cameraRig" position="0 -1 5">
        <a-camera look-controls></a-camera>
      </a-entity>

      <!-- ãƒ¢ãƒ‡ãƒ« -->
      <a-assets>
        <a-asset-item id="kaijyu-asset" src="kaijyu.glb"></a-asset-item>
      </a-assets>

      <!-- ğŸ¦– æ€ªç£ï¼”ä½“ -->
      <a-entity id="kaijyu1" gltf-model="#kaijyu-asset" scale="1.5 1.5 1.5" visible="false"></a-entity>
      <a-entity id="kaijyu2" gltf-model="#kaijyu-asset" scale="1.5 1.5 1.5" visible="false"></a-entity>
      <a-entity id="kaijyu3" gltf-model="#kaijyu-asset" scale="1.5 1.5 1.5" visible="false"></a-entity>
      <a-entity id="kaijyu4" gltf-model="#kaijyu-asset" scale="1.5 1.5 1.5" visible="false"></a-entity>
    </a-scene>

    <script>
      const soundEntity = document.querySelector('#sound-player');
      const roarSound = "åŠ¹æœéŸ³/hell_gear.mp3";
      const ambientSounds = [
        "åŠ¹æœéŸ³/é¢¨ãŒå¹ã1.mp3",
        "åŠ¹æœéŸ³/é¢¨ãŒå¹ã2.mp3",
        "åŠ¹æœéŸ³/çªé¢¨ãŒå¹ã.mp3"
      ];

      const kaijyus = [
        document.querySelector('#kaijyu1'),
        document.querySelector('#kaijyu2'),
        document.querySelector('#kaijyu3'),
        document.querySelector('#kaijyu4')
      ];

      // ãƒ¢ãƒ‡ãƒ«ã‚’æš—ã‚ã«
      kaijyus.forEach(k => {
        k.addEventListener('model-loaded', () => {
          k.object3D.traverse(node => {
            if (node.isMesh && node.material) node.material.color.multiplyScalar(0.7);
          });
        });
      });

      // ğŸµ åŠ¹æœéŸ³å†ç”Ÿ
      function playSound(file, volume = 1.0) {
        const s = document.createElement('a-entity');
        s.setAttribute('sound', {
          src: `url(${file})`,
          autoplay: true,
          volume,
          loop: false
        });
        document.querySelector('a-scene').appendChild(s);
        setTimeout(() => s.remove(), 7000);
      }

      // ğŸŒ² èƒŒæ™¯éŸ³ãƒ«ãƒ¼ãƒ—
      function startAmbientLoop() {
        let i = 0;
        playSound(ambientSounds[i]);
        setInterval(() => {
          i = (i + 1) % ambientSounds.length;
          playSound(ambientSounds[i], 0.6);
        }, 10000);
      }

      // ğŸ’¥ å‡ºç¾å‡¦ç†
      function triggerKaijyu(k) {
        // ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ï¼šæ¨ª -5ã€œ+5ã€å‰ -2.5ã€œ-4 ã®ç¯„å›²
        const xOffset = (Math.random() - 0.5) * 10; // å·¦å³åºƒã
        const zOffset = -2.5 - Math.random() * 1.5; // æ‰‹å‰ã€œå¥¥ã«ãƒ©ãƒ³ãƒ€ãƒ 
        const yPos = -2.5;
        const pos = `${xOffset} ${yPos} ${zOffset}`;

        k.setAttribute("visible", "true");
        k.setAttribute("position", pos);

        // ã‚«ãƒ¡ãƒ©æ–¹å‘ã‚’å‘ã‹ã›ã‚‹
        k.object3D.lookAt(new THREE.Vector3(0, yPos, 5));

        playSound(roarSound, 1.2);
        console.log(`ğŸ’¥ ${k.id} å‡ºç¾ (${pos})`);

        // 5ç§’å¾Œã«æ¶ˆãˆã‚‹
        setTimeout(() => {
          k.setAttribute("visible", "false");
        }, 5000);
      }

      // ğŸ² å„æ€ªç£ã®ãƒ©ãƒ³ãƒ€ãƒ å‡ºç¾ãƒ«ãƒ¼ãƒ—
      function startKaijyuLoops() {
        kaijyus.forEach(k => {
          const loop = () => {
            const delay = Math.random() * 8000 + 3000; // 3ã€œ11ç§’
            setTimeout(() => {
              triggerKaijyu(k);
              loop();
            }, delay);
          };
          loop();
        });
      }

      // â–¶ åˆå›ã‚¯ãƒªãƒƒã‚¯ã§é–‹å§‹
      window.addEventListener('click', () => {
        startAmbientLoop();
        startKaijyuLoops();
        console.log("ğŸ’¥ 4ä½“ãƒ©ãƒ³ãƒ€ãƒ å‡ºç¾é–‹å§‹");
      }, { once: true });
    </script>
  </body>
</html>
