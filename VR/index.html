<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Random Spiders Move + Fade Out</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- ç…§æ˜ -->
      <a-light type="ambient" color="#777"></a-light>
      <a-light type="directional" color="#fff" position="1 2 2"></a-light>

      <!-- èƒŒæ™¯ -->
      <a-sky src="mori.jpg" rotation="0 -130 0"></a-sky>

      <!-- åŠ¹æœéŸ³ç”¨ -->
      <a-entity id="sound-player"></a-entity>
    </a-scene>

    <script>
      const scene = document.querySelector('a-scene');

      // ğŸ•·ï¸ ã‚¯ãƒ¢ã‚’10åŒ¹ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
      const numSpiders = 10;

      for (let i = 0; i < numSpiders; i++) {
        const spider = document.createElement('a-entity');
        spider.setAttribute('gltf-model', 'spider.glb');
        spider.setAttribute('animation-mixer', '');

        // ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«ãƒ»é€²è¡Œè·é›¢ã‚’è¨­å®š
        const startX = (Math.random() - 0.5) * 8;   // -4ã€œ4ã®ç¯„å›²ã§æ¨ªã«ã°ã‚‰ã‘ã‚‹
        const startZ = -3 - Math.random() * 3;      // æ‰‹å‰ã€œå¥¥ã«ãƒ©ãƒ³ãƒ€ãƒ é…ç½®
        const scale = Math.random() > 0.5 ? '0.2 0.2 0.2' : '0.1 0.1 0.1';
        const moveDistance = 6 + Math.random() * 3; // å‰é€²è·é›¢ã‚’å°‘ã—å¤‰åŒ–
        const moveDuration = 6000 + Math.random() * 4000; // ç§»å‹•æ™‚é–“ã‚‚ãƒ©ãƒ³ãƒ€ãƒ 

        spider.setAttribute('position', `${startX} -1.5 ${startZ}`);
        spider.setAttribute('scale', scale);
        spider.setAttribute('animation__move', `
          property: position;
          to: ${startX} -1.5 ${startZ + moveDistance};
          dur: ${moveDuration};
          easing: linear;
          loop: false;
        `);

        scene.appendChild(spider);

        // ğŸ•·ï¸ ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å¾Œã«é€æ˜åŒ–å¯¾å¿œ
        spider.addEventListener('model-loaded', () => {
          spider.object3D.traverse(node => {
            if (node.isMesh) {
              node.material.transparent = true;
            }
          });
        });

        // ğŸ•·ï¸ å‰é€²å®Œäº†å¾Œãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        spider.addEventListener('animationcomplete__move', () => {
          let opacity = 1.0;
          const fadeDuration = 2000;
          const fadeSteps = 20;
          const stepTime = fadeDuration / fadeSteps;

          const fadeInterval = setInterval(() => {
            opacity -= 1 / fadeSteps;
            if (opacity <= 0) {
              opacity = 0;
              clearInterval(fadeInterval);
              spider.parentNode.removeChild(spider);
            }

            spider.object3D.traverse(node => {
              if (node.isMesh && node.material) {
                node.material.opacity = opacity;
              }
            });
          }, stepTime);
        });
      }

      // ğŸµ ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœéŸ³ãƒ«ãƒ¼ãƒ—
      const soundFiles = [
        "åŠ¹æœéŸ³/hell_gear.mp3",
        "åŠ¹æœéŸ³/çªé¢¨ãŒå¹ã.mp3",
        "åŠ¹æœéŸ³/é¢¨ãŒå¹ã1.mp3",
        "åŠ¹æœéŸ³/é¢¨ãŒå¹ã2.mp3",
        "åŠ¹æœéŸ³/é¢¨ãŒå¹ã3.mp3",
        "åŠ¹æœéŸ³/é¢¨ãŒå¹ã4.mp3"
      ];

      const soundEntity = document.querySelector('#sound-player');

      function playRandomSound() {
        const randomSound = soundFiles[Math.floor(Math.random() * soundFiles.length)];
        soundEntity.setAttribute('sound', `src: url(${randomSound}); autoplay: true; volume: 1.0; loop: false;`);
        soundEntity.addEventListener('sound-loaded', () => {
          soundEntity.components.sound.playSound();
        }, { once: true });
      }

      function startRandomLoop() {
        playRandomSound();
        setInterval(() => {
          playRandomSound();
        }, Math.random() * 7000 + 8000);
      }

      window.addEventListener('load', startRandomLoop);
    </script>
  </body>
</html>
