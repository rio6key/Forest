<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Spiders + Kaijyu Move + Animation + Lowered Camera</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- ç…§æ˜Ž -->
      <a-light type="ambient" color="#666"></a-light>
      <a-light type="directional" color="#fff" position="2 4 3"></a-light>

      <!-- èƒŒæ™¯ -->
      <a-sky src="mori.jpg" rotation="0 -130 0"></a-sky>

      <!-- åŠ¹æžœéŸ³ -->
      <a-entity id="sound-player"></a-entity>

      <!-- ã‚«ãƒ¡ãƒ©ï¼ˆå°‘ã—ä¸‹ã’ãŸä½ç½®ï¼‰ -->
      <a-entity id="cameraRig" position="0 -0.8 5">
        <a-camera look-controls></a-camera>
      </a-entity>

      <!-- æ€ªç£ãƒ¢ãƒ‡ãƒ« -->
      <a-asset-item id="kaijyu-asset" src="kaijyu.glb"></a-asset-item>
      <a-entity
        id="kaijyu"
        gltf-model="#kaijyu-asset"
        position="0 -2.5 -10"
        rotation="0 0 0"
        scale="0.5 0.5 0.5"
        animation-mixer
        animation__move="property: position; to: 0 -2.5 5; dur: 25000; easing: linear; loop: false;"
      ></a-entity>

    </a-scene>

    <script>
      const scene = document.querySelector('a-scene');
      const numSpiders = 15;

      // ðŸ•’ 3ç§’å¾Œã«ã‚¯ãƒ¢ç”Ÿæˆé–‹å§‹
      setTimeout(() => {
        for (let i = 0; i < numSpiders; i++) {
          const spider = document.createElement('a-entity');
          spider.setAttribute('gltf-model', 'spider.glb');
          spider.setAttribute('animation-mixer', '');

          // ðŸŽ² ãƒ©ãƒ³ãƒ€ãƒ è¨­å®š
          const startX = (Math.random() - 0.5) * 8;
          const startZ = -6 - Math.random() * 4;
          const yPos = -2.5;
          const scale = Math.random() > 0.5 ? '0.2 0.2 0.2' : '0.1 0.1 0.1';
          const moveDistance = 7 + Math.random() * 3;
          const moveDuration = 7000 + Math.random() * 3000;

          spider.setAttribute('position', `${startX} ${yPos} ${startZ}`);
          spider.setAttribute('scale', scale);

          spider.setAttribute('animation__move', `
            property: position;
            to: ${startX} ${yPos} ${startZ + moveDistance};
            dur: ${moveDuration};
            easing: linear;
            loop: false;
          `);

          scene.appendChild(spider);

          // ã‚¯ãƒ¢é€æ˜ŽåŒ–
          spider.addEventListener('model-loaded', () => {
            spider.object3D.traverse(node => {
              if (node.isMesh) node.material.transparent = true;
            });
          });

          // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå‡¦ç†
          spider.addEventListener('animationcomplete__move', () => {
            let opacity = 1.0;
            const fadeDuration = 2000;
            const fadeSteps = 20;
            const stepTime = fadeDuration / fadeSteps;

            const fadeInterval = setInterval(() => {
              opacity -= 1 / fadeSteps;
              if (opacity <= 0) {
                opacity = 0;
                clearInterval(fadeInterval);
                spider.parentNode.removeChild(spider);
              }
              spider.object3D.traverse(node => {
                if (node.isMesh && node.material) node.material.opacity = opacity;
              });
            }, stepTime);
          });
        }
      }, 3000);

      // ðŸ¦– æ€ªç£ãƒ­ãƒ¼ãƒ‰å¾Œï¼šè‰²ã‚’æš—ã‚ã« & ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ
      const kaijyu = document.querySelector('#kaijyu');
      kaijyu.addEventListener('model-loaded', () => {
        kaijyu.object3D.traverse(node => {
          if (node.isMesh && node.material) {
            // å…¨ä½“ã®æ˜Žã‚‹ã•ã‚’å°‘ã—è½ã¨ã™
            node.material.color.multiplyScalar(0.6);
          }
        });
        // Blenderã§ã®ã‚¯ãƒªãƒƒãƒ—åã«åˆã‚ã›ã¦æŒ‡å®šï¼ˆä¾‹: "Walk"ï¼‰
        kaijyu.setAttribute('animation-mixer', 'clip: Walk; loop: repeat;');
      });

      // ðŸŽµ ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æžœéŸ³ãƒ«ãƒ¼ãƒ—
      const soundFiles = [
        "åŠ¹æžœéŸ³/hell_gear.mp3",
        "åŠ¹æžœéŸ³/çªé¢¨ãŒå¹ã.mp3",
        "åŠ¹æžœéŸ³/é¢¨ãŒå¹ã1.mp3",
        "åŠ¹æžœéŸ³/é¢¨ãŒå¹ã2.mp3",
        "åŠ¹æžœéŸ³/é¢¨ãŒå¹ã3.mp3",
        "åŠ¹æžœéŸ³/é¢¨ãŒå¹ã4.mp3"
      ];

      const soundEntity = document.querySelector('#sound-player');
      function playRandomSound() {
        const randomSound = soundFiles[Math.floor(Math.random() * soundFiles.length)];
        soundEntity.setAttribute('sound', `src: url(${randomSound}); autoplay: true; volume: 1.0; loop: false;`);
        soundEntity.addEventListener('sound-loaded', () => {
          soundEntity.components.sound.playSound();
        }, { once: true });
      }

      function startRandomLoop() {
        playRandomSound();
        setInterval(() => {
          playRandomSound();
        }, Math.random() * 7000 + 8000);
      }

      window.addEventListener('load', startRandomLoop);
    </script>
  </body>
</html>
